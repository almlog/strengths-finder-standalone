# メンバープロファイル分析

## ⚠️ 開発品質誓約

**このプロジェクトはSpec駆動開発とTDDを採用しています。**

開発者は必ず以下を確認してください：
- 📋 [開発品質誓約書](./DEVELOPMENT_QUALITY_PLEDGE.md) - 開発の度に確認必須
- 📖 Spec（IMPLEMENTATION_PLAN_AI_TDD.md）- 実行計画書として扱う
- ✅ タスク開始前・実装中・完了前にSpecと照合

**品質基準を満たさない実装は絶対に行いません。**

---

## 概要
このツールは、チームメンバーの強み（ストレングスファインダー）と性格（16Personalities）を可視化・分析するためのWebアプリケーションです。完全にクライアントサイドで動作し、個人情報はブラウザのローカルストレージにのみ保存されます。

## 📚 ドキュメント

包括的なドキュメントは `docs/notebooklm/` に整備されています：

| ドキュメント | 説明 |
|-------------|------|
| [システム概要](docs/notebooklm/00_OVERVIEW.md) | クイックリファレンス、機能一覧 |
| [ユーザーマニュアル](docs/notebooklm/01_USER_MANUAL.md) | 全機能の操作ガイド |
| [管理者ガイド](docs/notebooklm/02_ADMINISTRATOR_GUIDE.md) | Firebase管理、ユーザー管理 |
| [システム仕様書](docs/notebooklm/03_SYSTEM_SPECIFICATION.md) | 技術アーキテクチャ、データモデル |
| [分析理論](docs/notebooklm/04_ANALYSIS_THEORY.md) | MBTI×資質統合分析の理論的背景 |
| [開発ロードマップ](docs/notebooklm/05_DEVELOPMENT_ROADMAP.md) | バージョン履歴、今後の計画 |
| [APIリファレンス](docs/notebooklm/06_API_REFERENCE.md) | サービス/Hook/ContextのAPI仕様 |

詳細は [docs/README.md](docs/README.md) を参照してください。

## 🌐 公開URL
**https://almlog.github.io/strengths-finder-standalone**

GitHub Pagesでホスティングされており、インストール不要で即座に利用できます。

## 特徴
- 🔐 **Firebase認証**: メールリンク認証によるセキュアなログイン
  - 管理者による招待制（ドメイン制限）
  - パスワードレス認証とパスワード認証の両対応
  - ロールベースアクセス制御（管理者/一般ユーザー）
- 🔒 **プライバシー重視**: すべてのデータはローカルに保存され、外部サーバーには送信されません
- 📊 **多角的な分析**: 個人分析、部署分析、選択メンバー分析、所有者分析（逆引き）
- 💾 **データのインポート/エクスポート**: JSON形式でバックアップと共有が可能
- 🎯 **2つの診断ツール対応**:
  - ストレングスファインダー（34の資質）
  - 16Personalities（16タイプ + アイデンティティ）
- 📱 **レスポンシブデザイン**: デスクトップ・タブレット・モバイルに対応
  - **🆕 メンバーリスト折りたたみ（v3.4.5）**: スクロール軽減のためリストを折りたたみ可能
    - PC: 横方向に折りたたみ（サイドバーを細いバーに収納）
    - スマホ: 縦方向に折りたたみ（タイトルのみ表示）
    - 折りたたみ状態はブラウザに自動保存
  - **🆕 勤怠分析ボタンのモバイル最適化（v3.4.5）**: はみ出し解消、自動折り返し
- 👥 **カスタム役職機能**: 標準役職に加え、自由に役職を追加可能
- 🌙 **ダークモード対応**: Light/Darkテーマの切り替えが可能（設定は自動保存）
- 💰 **マネージャーモード（v3.1）**: メンバーごとの利益率計算機能
  - 雇用形態別の原価計算（正社員・契約社員・ビジネスパートナー）
  - ステージマスタ管理（ステージごとの人件費合計・経費率設定）
  - 単価情報管理（メンバーごとの売上単価・契約単価入力）
  - 利益率ダッシュボード（総売上・総原価・総利益・年間予測）
  - チーム全体の利益集計とステージ別分析
- 🔄 **チームシミュレーション（v3.2）**: 組織変更の事前シミュレーション
  - ドラッグ&ドロップによる動的なチーム編成
  - 強み分布と利益率のリアルタイム可視化
  - グループ分析とチーム特性ナラティブの自動生成
  - シナリオ保存・比較・本番反映機能
- 📊 **勤怠分析（v3.4）**: 楽楽勤怠連携による労務管理支援
  - XLSXファイルのアップロードと自動分析
  - 打刻漏れ・申請漏れ・備考欄チェックの違反検出
  - 36協定残業時間チェック（7段階アラート）
  - 予兆アラート機能（月末残業超過予測）
  - 8時出社カレンダー登録者への補正処理（カレンダー不整合対応）
  - StrengthsFinder連携（従業員のTop5表示）
- 🚃 **交通情報（v3.5）**: Mini Tokyo 3D統合によるリアルタイム運行情報
  - 3Dマップで首都圏の電車位置をリアルタイム表示
  - **🆕 遅延情報ティッカー**: 主要路線の遅延をマーキー表示（5分自動更新）
  - **🆕 遅延履歴モーダル**: クリックで6時間分の遅延履歴を表示
  - **🆕 遅延報告メッセージ作成**: ワンタップでLINEWORKS用の遅延報告を生成
  - **🆕 電車タップ連携**: マップ上の電車をタップして遅延報告に路線名を自動入力
  - JR/地下鉄/私鉄のフィルタリング機能
  - 全画面表示対応

## クイックスタート

### オンライン利用（推奨）
ブラウザで以下のURLにアクセスするだけで利用できます：
**https://almlog.github.io/strengths-finder-standalone**

### ローカル開発環境のセットアップ

#### 依存関係のインストール
```bash
git clone https://github.com/almlog/strengths-finder-standalone.git
cd strengths-finder-standalone
npm install
```

#### 開発サーバーの起動
```bash
npm start
```
開発サーバー: http://localhost:3006

> **注意**: ログインに失敗する場合は `.env.local` の `REACT_APP_USE_EMULATOR=false` を確認してください。

#### 本番用ビルド
```bash
npm run build
```

## 主な機能

### メンバー管理
- メンバーの追加・編集・削除
- 社員番号、氏名、部署コード、役職の管理
- **ストレングスファインダー**: 5つの強み（資質）の順位付け
- **16Personalities**: 性格タイプ（16種）+ アイデンティティ（A/T）
- カスタム役職の追加（JSONで色とアイコンをカスタマイズ可能）

### 分析機能
- **個人分析**: 選択したメンバーの強みと性格を視覚的に分析
  - **🆕 プロファイル分析（v1.3完成）**:
    - **MBTI×資質の統合分析**:
      - **相性スコア**: 重み付き加算（TOP5資質 × MBTI相性）
      - **チーム適合度**: Belbin 9ロール理論適用（内向型・外向型を等しく評価）
      - **リーダーシップ潜在力**: Bass変革型リーダーシップ理論ベース
      - 16パターンの役割自動推論（MBTIと資質の組み合わせから）
      - スコアベースの4文構成サマリー（統合型/バランス型/多面型の判定）
      - チーム協調型/個人作業型の働き方分析
      - リーダー型/専門家型の役割期待メッセージ
    - **役割説明機能**: 各統合分析結果（例：「ビジョン構築者」）の詳細説明を表示
    - **🆕 SF-onlyモード大幅改善（v1.3）**:
      - **344,960通りの資質組み合わせを適切に個別表現**
      - **34種類の資質特性記述**: 各資質に固有の特徴フレーズ（例：「達成欲」→「目標達成に向けて懸命に働き」）
      - **7段階のスコア評価**: チーム適合度・リーダーシップを細分化（旧3段階→新7段階）
      - **TOP5全体分析**: 20+種類の役割タイプ（旧7種類→新20+種類）
      - **数千〜数万通りのパターン生成**: 固定テンプレート廃止、動的な説明文生成
      - 簡潔な表示（プロファイルサマリーのみ、16Personalities追加を促すメッセージ付き）
  - 強みのバランス表示（全34資質を4カテゴリで可視化）
  - 16Personalities タイプ別の詳細情報表示
- **🆕 部署分析（v3.2.1）**: 部署コードごとの強みの傾向を3分割UIで可視化
  - **円グラフ**: 強みグループ分布（実行力・影響力・人間関係構築力・戦略的思考力の4カテゴリ割合）
  - **棒グラフ**: 頻出資質TOP10（所持メンバー名のツールチップ付き）
  - **分析結果コメント**: チーム特性ナラティブ自動生成
    - タイトル（バランス型/特化型/複合型チームの判定）
    - サマリー（34資質の質的分析に基づく文章）
    - 頻出資質TOP5（保有率パーセンテージ付き）
    - チームの可能性（3〜5項目の具体的な強み）
- **選択メンバー分析**: 複数メンバーを選択して強みと性格を集計分析
- **所有者分析**: 特定の資質や性格タイプを持つメンバーの逆引き検索
- **🆕 チームシミュレーション（v3.2）**: 来期の組織変更を事前にシミュレーション
  - ドラッグ&ドロップでメンバーをグループ間で移動
  - リアルタイムで強み分布と利益率を可視化
  - **グループ分析**: PersonalityAnalysisEngine統合（相性スコア、チーム適合度、バランス型判定）
  - **チーム特性ナラティブ**: 34資質の質的分析とチームの可能性を自動生成
  - シナリオのエクスポート/インポート/本番反映機能
- **🆕 勤怠分析（v3.4）**: 楽楽勤怠からエクスポートしたXLSXを分析
  - **違反検出**: 打刻漏れ、休憩不足、遅刻/早退/早出申請漏れ、時間有休打刻漏れ、深夜休憩申請漏れ、備考欄チェック
  - **36協定チェック**: 7段階アラート（35h/45h/55h/65h/70h/80h/100h）
  - **予兆アラート**: 月末までの残業超過を予測し早期警告
  - **8時出社カレンダー補正**: 9時出社メンバーが8時カレンダーに登録されている場合の誤検出を補正
  - **StrengthsFinder連携**: 登録済み従業員のTop5資質をツールチップ表示
  - サマリー/従業員別/部門別/違反一覧の4タブ構成
  - CSV出力、サマリーPDF出力機能
  - **🆕 個人分析PDF（v3.4.3）**: 従業員別タブから個人の詳細レポートを出力
    - 勤務サマリー（出勤日数、定時退社率など）
    - 就業実績時間、残業・36協定アラート
    - 申請サマリー（24種類の申請タイプに対応）
    - 違反・注意事項一覧
  - **🆕 申請カウント機能強化（v3.4.4）**: 楽楽勤怠マニュアル準拠の24種類の申請に対応
    - 勤務関連9項目（残業、早出、電車遅延、時差出勤など）
    - 休暇・休日関連15項目（有休、午前/午後有休、時間有休、振休、代休、特休、生理休暇など）
  - **🆕 シート名からの始業時刻抽出（v3.4.4）**: 早出判定の精度向上
    - シート名パターン（例: `KDDI_日勤_800-1630～930-1800`）から始業時刻を自動抽出
    - 申請内容 > シート名 > デフォルト9時の優先順位で判定
  - **🆕 出勤率計算の改善（v3.4.4）**: 欠勤のみが出勤率に影響（有休等は出勤扱い）
  - **🆕 従業員一覧に欠勤カラム追加（v3.4.4）**: 欠勤数を赤色ハイライトで表示
  - **🆕 LINE WORKS通知（v3.6）**: 勤怠分析結果をLINE WORKSトークルームに直接送信
    - 入力漏れ・申請漏れ・36協定アラートの自動送信
    - 送信前プレビュー・編集機能
    - Firebase Cloud Function経由の安全な送信（Webhook URLはサーバー管理）
    - 現在は東SI1部リーダー以上ルームへの送信のみ対応

### データ管理
- **エクスポート**: 現在のデータをJSONファイルとして保存（Context stateから直接エクスポート）
- **インポート**: JSONファイルからデータを復元
  - **🆕 インポート競合解決機能**: 既存データと重複する場合、以下の戦略から選択可能
    - **Replace（全置換）**: 既存データを完全削除し、インポートデータで置き換え
    - **Add（新規のみ追加）**: 重複しないメンバーのみを追加（既存データは保持）
    - **Merge（マージ&更新）**: 重複メンバーは更新、新規メンバーは追加
  - **🔧 v1.1で修正**: マージ後の削除・更新・エクスポートが正しく動作するよう、Context state管理を改善
- **ローカルストレージ**: ブラウザにデータを自動保存（useEffectによる自動同期）

### 交通情報タブ（v3.5）

Mini Tokyo 3Dを統合した首都圏のリアルタイム運行情報表示機能です。

#### 🗺️ マップ操作
- **ドラッグ**: 地図を移動
- **ピンチ/スクロール**: ズームイン/アウト
- **電車タップ**: 選択した電車の詳細情報を表示
- **全画面ボタン**: 大画面で詳細を確認

#### 🚨 遅延情報機能
- **ティッカー表示**: 画面上部に遅延路線をマーキー表示（5分自動更新）
- **ティッカークリック**: 遅延履歴モーダルを開く
- **履歴モーダル**: 直近6時間の遅延情報を一覧表示
- **フィルター**: JR/地下鉄/私鉄で絞り込み可能

#### 📝 遅延報告メッセージ作成（革新機能）
遅延発生時のLINEWORKS連絡を効率化する機能です。

**使い方:**
1. 遅延情報ティッカーをクリック → 履歴モーダルを開く
2. 「遅延報告メッセージ作成」セクションで入力
   - **路線名**: 自動入力（遅延情報から選択）または手動入力
   - **遅延見込み**: 到着が遅れる見込み時間（分）を入力
   - **現在地**: 「現在地から検出」で最寄り駅を自動取得、または手動選択
3. プレビューを確認し「メッセージをコピー」
4. LINEWORKSに貼り付けて送信

**電車タップ連携:**
- マップ上の電車をタップ → 路線名が通知バーに表示
- 「遅延報告を作成」ボタンで履歴モーダルを開き、路線名が自動入力される

**生成されるメッセージ例:**
```
おはようございます。
"中央線快速 人身事故による遅延"の影響で遅延が発生しています。
その影響で現場到着が15分遅れる見込みです。
現在新宿です。
```

#### 💼 ハイブリッド勤務での活用
- **出勤前**: 通勤路線の運行状況をリアルタイム確認
- **遅延発生時**: 遅延報告メッセージをワンタップで作成・送信
- **運行停止時**: リモートワークへの切り替えを検討

> ⚠️ **重要**: リモートワークへの切り替えは必ず上長に確認してください

### マネージャーモード（v3.1）
URLパラメータ `?mode=manager` でマネージャーモードに切り替え可能：
- **利益率計算機能**: メンバーごとの売上・原価・利益を計算
  - **正社員（S1-S4）**: 人件費合計 + (人件費合計 × 給与経費率)
  - **契約社員**: 契約単価 + 固定経費(50,000円) + (契約単価 × 社内経費率26%)
  - **ビジネスパートナー**: 契約単価 + 固定経費(40,000円) + (契約単価 × 経費率9%)
- **ステージマスタ設定**: ステージごとの人件費合計・経費率・固定経費を管理
  - 人件費合計: 給与 + 交通費 + 残業見込み + 賞与引当などの総額（円/月）
  - 経費率: 所属部署諸経費 + 本社経費 + 営業口銭の合計をステージメンバーで平均した値
  - JSONインポート/エクスポート機能（置換・新規追加・マージの3戦略）
- **単価情報管理**: メンバーごとの売上単価・契約単価を入力
  - 月額・時給の両方に対応
  - リアルタイムで原価・利益・利益率をプレビュー表示
- **利益率ダッシュボード（v3.1.1）**: チーム全体の利益集計を統合表示
  - 総売上・総原価・総利益・利益率の一覧表示
  - 年間予測（月次×12ヶ月）の自動計算
  - ステージ別内訳（S1→S2→S3→S4→CONTRACT→BP の固定順序）
  - 部署フィルター機能（全社/部署別の切り替え）

## デプロイ

このアプリケーションは GitHub Actions による自動デプロイが設定されています。

### 🚨 重要：push前の必須チェック

> **2026-01-31インシデント教訓**: ローカル `npm run build` 成功でもCI環境で失敗することがある

```bash
# push前に必ずCI環境を再現してビルド確認
# Windows
set CI=true && npm run build

# Mac/Linux
CI=true npm run build
```

**理由**: CI環境（`CI=true`）ではESLint警告がエラーに昇格するため、ローカルビルド成功 ≠ CI環境ビルド成功

### 自動デプロイ（GitHub Pages）
`main` ブランチへのpush時に自動的に以下が実行されます：
1. Node.js環境のセットアップ
2. 依存関係のインストール (`npm ci`)
3. プロダクションビルド (`npm run build` with `CI=true`)
4. GitHub Pagesへのデプロイ

公開URL: **https://almlog.github.io/strengths-finder-standalone**

### 手動デプロイ
他の静的Webホスティングサービスにデプロイする場合：

```bash
# ビルドを作成
npm run build

# buildフォルダの内容を以下のいずれかにアップロード：
# - 社内Webサーバー
# - Azure Static Web Apps
# - AWS S3 + CloudFront
# - Netlify/Vercel
```

## データフォーマット

### メンバーデータ
```json
{
  "customPositions": [
    {
      "id": "CUSTOM_1234567890",
      "name": "副事業部長",
      "displayName": "副事業部長",
      "color": "#9E9E9E",
      "icon": "crown"
    }
  ],
  "members": [
    {
      "id": "12345678",
      "name": "山田太郎",
      "department": "13D12345",
      "position": "MANAGER",
      "strengths": [
        { "id": 1, "score": 1 },
        { "id": 16, "score": 2 },
        { "id": 31, "score": 3 },
        { "id": 4, "score": 4 },
        { "id": 22, "score": 5 }
      ]
    }
  ]
}
```

### カスタム役職のカスタマイズ
エクスポートしたJSONファイル内でカスタム役職の色とアイコンを変更できます：
- **color**: HEX形式のカラーコード（例: `#FF5722`）
- **icon**: `"crown"` | `"circle"` | `"star"`

## 技術スタック
- React 19 + TypeScript
- Tailwind CSS 3.4.1 (Dark Mode対応)
- Recharts (グラフ表示)
- XLSX (Excelファイル解析)
- @dnd-kit (ドラッグ&ドロップ)
- Lucide React (アイコン)
- Firebase Authentication (認証)
- Firebase Cloud Functions (LINE WORKS送信プロキシ)
- LocalStorage API (データ永続化)
- Mini Tokyo 3D (3D鉄道運行可視化)
- ODPT API (公共交通オープンデータ)
- GitHub Actions (CI/CD)
- GitHub Pages (ホスティング)

## 認証システム

### 概要
Firebase Authenticationを使用した招待制の認証システムです。

### ユーザー登録フロー
1. 管理者が新規ユーザーのメールアドレスで招待リンクを送信
2. ユーザーがメールのリンクをクリック
3. パスワード設定画面でパスワードを設定
4. ログイン完了

### 管理者権限
- Firebase Admin SDKを使用してカスタムクレームを設定
- 詳細は [docs/auth/TECHNICAL_SPECIFICATION.md](docs/auth/TECHNICAL_SPECIFICATION.md) を参照

```bash
# 管理者権限の付与（要サービスアカウントキー）
npm run admin:set suzuki.shunpei@altx.co.jp

# ユーザー一覧の確認
npm run admin:list
```

### ドメイン制限
許可されたドメイン（altx.co.jp）のメールアドレスのみ登録可能です。

## 分析ロジック

### チーム特性ナラティブ（部署分析・チームシミュレーション共通）

**SimulationService.calculateTeamNarrative()** による34資質の質的分析:

#### 1. 資質頻度集計
- メンバー全員のTOP5資質（スコア1〜5）を集計
- 各資質の出現回数と保有率（%）を計算
- 頻度順にソートして上位資質を特定

#### 2. カテゴリ分布分析
4つの強みグループの資質数をカウント:
- **実行力** (EXECUTING): 達成欲、アレンジ、信念、公平性、慎重さ、規律性、目標志向、責任感、回復志向
- **影響力** (INFLUENCING): 活発性、指令性、コミュニケーション、競争性、最上志向、自己確信、自我、社交性
- **人間関係構築力** (RELATIONSHIP_BUILDING): 適応性、運命思考、成長促進、共感性、調和性、包含、個別化、ポジティブ、親密性
- **戦略的思考力** (STRATEGIC_THINKING): 分析思考、原点思考、未来志向、着想、収集心、内省、学習欲、戦略性

#### 3. チームタイプの判定
カテゴリ分布に基づいて自動分類:
- **バランス型チーム**: 全カテゴリが20〜35%の範囲で均等に分布
- **特化型チーム**: 1カテゴリが40%以上を占める（例: 「実行力特化チーム」）
- **複合型チーム**: 2カテゴリが各30%以上（例: 「実行力×戦略的思考力チーム」）
- **中心型チーム**: 上記に該当しない場合、最多カテゴリを中心と表現（例: 「影響力中心チーム」）

#### 4. サマリー文生成
TOP3資質とチームタイプから文章を自動生成:
```
このチームは「[資質1]」「[資質2]」「[資質3]」を多く持つメンバーで構成されており、
[チームの特徴]が期待できます。[カテゴリ特性]、[チーム規模に応じた分析]。
```

#### 5. チームの可能性（3〜5項目）
頻出資質とカテゴリ分布から具体的な強みを生成:
- 各カテゴリが30%以上の場合、そのカテゴリ特有の可能性を追加
- TOP3資質の特性を反映した可能性を追加
- チームサイズに応じた表現を調整

### 例: 実行力特化チーム（達成欲・責任感・規律性が多い）
```
タイトル: 実行力特化チーム
サマリー: このチームは「達成欲」「責任感」「規律性」を多く持つメンバーで構成されており、
         高い実行力と確実な成果達成が期待できます。計画通りに物事を進め、責任を持って
         タスクを完遂する力が強みです。
可能性:
  - 目標達成に向けて着実に進める実行力
  - 責任感を持ってタスクを完遂する信頼性
  - 規律を守り、計画通りに進める組織力
```

## 開発者
**SUZUKI Shunpei**
suzuki.shunpei@altx.co.jp

## ライセンス
社内利用限定