# Firebase Authentication 機能要件定義書

**バージョン**: 1.0
**作成日**: 2025-12-23
**プロジェクト**: StrengthsFinder統合分析ツール
**担当**: SUZUKI Shunpei

---

## 📋 目次

1. [概要](#概要)
2. [背景と目的](#背景と目的)
3. [機能要件](#機能要件)
4. [非機能要件](#非機能要件)
5. [ユーザーストーリー](#ユーザーストーリー)
6. [制約事項](#制約事項)
7. [受け入れ基準](#受け入れ基準)

---

## 概要

### プロジェクト背景

現在、StrengthsFinder統合分析ツールは完全なクライアントサイドアプリケーションとして動作しており、ユーザー認証機能がない。マネージャーモード（利益率計算等）などの機密機能が実装されたため、適切なアクセス制御が必要となった。

### 解決すべき課題

1. **アクセス制御の欠如**: 誰でもURLを知っていればマネージャーモードにアクセス可能
2. **ロール管理の必要性**: 管理者と一般ユーザーで機能を分ける必要がある
3. **監査証跡**: 誰がいつアクセスしたかの記録がない

### 目標

- Firebase Authenticationを使用したセキュアな認証機能の実装
- ドメイン制限（@altx.co.jp のみ）による社内限定アクセス
- 管理者/一般ユーザーのロールベースアクセス制御（RBAC）
- ゼロコスト運用の継続（Firebase無料枠内）

---

## 背景と目的

### なぜ認証が必要か

#### 1. セキュリティリスク

現状の問題：
- メンバーの個人情報（MBTI、資質）が誰でも閲覧可能
- 利益率などの財務情報が保護されていない
- データの改ざんリスク

#### 2. コンプライアンス

- 個人情報保護法への対応
- 社内セキュリティポリシーへの準拠
- 監査要件の充足

#### 3. 機能の段階的公開

- マネージャーモード: 管理者のみ
- 勤怠分析機能（将来実装）: 管理者のみ
- 通常のプロファイル分析: 全ユーザー

### ゼロコスト原則の維持

- Firebase Authentication無料枠: 月間10,000アクティブユーザー
- 対象: 50名（最大500名想定）
- ✅ 完全無料で運用可能

---

## 機能要件

### FR-001: ユーザー登録機能

**優先度**: 必須（Must Have）

#### 機能概要
社員が自分でアカウントを作成できる。

#### 詳細仕様

**入力**
- メールアドレス（@altx.co.jp のみ許可）

**処理**
1. ドメイン検証（@altx.co.jp以外はエラー）
2. Firebase Email Link送信
3. LocalStorageにメールアドレス保存

**出力**
- 登録リンクメール送信
- 成功メッセージ表示

**エラーハンドリング**
- 無効なドメイン → エラーメッセージ表示
- メール送信失敗 → エラーメッセージ + リトライ案内
- 既存アカウント → ログイン画面への誘導

**受け入れ基準**
- [ ] @altx.co.jp のメールアドレスでのみ登録可能
- [ ] その他のドメインはエラーメッセージ表示
- [ ] メール送信後、確認メッセージが表示される
- [ ] 24時間以内にリンクが有効

---

### FR-002: パスワード設定機能

**優先度**: 必須（Must Have）

#### 機能概要
メールのリンクからパスワードを設定する。

#### 詳細仕様

**入力**
- Email Link（URLパラメータ）
- パスワード（8文字以上）
- パスワード確認

**処理**
1. Email Link検証
2. LocalStorageからメールアドレス取得
3. パスワードバリデーション
4. Firebase Authentication アカウント作成
5. Email/Password認証にリンク

**出力**
- アカウント作成完了メッセージ
- ログイン画面へリダイレクト

**エラーハンドリング**
- 無効/期限切れリンク → エラーメッセージ + 再登録案内
- パスワード不一致 → エラーメッセージ
- 弱いパスワード → エラーメッセージ + 要件提示

**受け入れ基準**
- [ ] 8文字以上のパスワード設定が必須
- [ ] パスワード確認入力が一致する必要がある
- [ ] リンク期限切れの場合、適切なエラーメッセージ表示
- [ ] アカウント作成後、ログイン画面へ遷移

---

### FR-003: ログイン機能

**優先度**: 必須（Must Have）

#### 機能概要
メールアドレスとパスワードでログインする。

#### 詳細仕様

**入力**
- メールアドレス
- パスワード

**処理**
1. Firebase signInWithEmailAndPassword
2. 認証成功時、ダッシュボードへリダイレクト
3. ロール情報（admin/user）を取得

**出力**
- ログイン成功 → ダッシュボード画面
- ログイン失敗 → エラーメッセージ

**エラーハンドリング**
- 認証情報不正 → エラーメッセージ
- アカウント不存在 → エラーメッセージ
- 試行回数超過 → 一時ロック + エラーメッセージ

**受け入れ基準**
- [ ] 正しい認証情報でログイン成功
- [ ] 誤った認証情報で適切なエラーメッセージ表示
- [ ] ログイン後、ダッシュボードへ遷移
- [ ] セッション維持（ページリロード後も継続）

---

### FR-004: ロールベースアクセス制御（RBAC）

**優先度**: 必須（Must Have）

#### 機能概要
管理者と一般ユーザーで利用可能機能を分ける。

#### 詳細仕様

**ロール種別**

| ロール | 権限 |
|--------|------|
| **admin** | すべての機能にアクセス可能 |
| **user** | 一般機能のみアクセス可能 |

**権限マトリクス**

| 機能 | user | admin |
|-----|------|-------|
| メンバープロファイル閲覧 | ✅ | ✅ |
| 個人分析 | ✅ | ✅ |
| 部署分析 | ✅ | ✅ |
| 選択メンバー分析 | ✅ | ✅ |
| メンバー追加/編集/削除 | ❌ | ✅ |
| チームシミュレーション | ❌ | ✅ |
| マネージャーモード（利益率） | ❌ | ✅ |
| 勤怠分析（将来実装） | ❌ | ✅ |

**処理**
1. Firebase Custom Claimsでロール管理
2. useAuthフックでロール取得
3. PrivateRouteコンポーネントで権限チェック

**受け入れ基準**
- [ ] 管理者はすべての機能にアクセス可能
- [ ] 一般ユーザーは管理者専用機能にアクセス不可
- [ ] 権限不足時、適切なエラーメッセージ表示

---

### FR-005: ログアウト機能

**優先度**: 必須（Must Have）

#### 機能概要
ユーザーがログアウトできる。

#### 詳細仕様

**処理**
1. Firebase signOut
2. LocalStorageクリア（必要に応じて）
3. ログイン画面へリダイレクト

**受け入れ基準**
- [ ] ログアウト後、認証状態がクリアされる
- [ ] ログアウト後、保護されたページにアクセス不可
- [ ] ログイン画面へリダイレクト

---

### FR-006: セッション管理

**優先度**: 必須（Must Have）

#### 機能概要
ログイン状態を維持する。

#### 詳細仕様

**処理**
1. Firebase onAuthStateChanged でセッション監視
2. ページリロード後も認証状態維持
3. トークンの自動更新

**受け入れ基準**
- [ ] ページリロード後もログイン状態維持
- [ ] ブラウザ再起動後もログイン状態維持（オプション）

---

## 非機能要件

### NFR-001: パフォーマンス

**要件**
- ログイン処理: 3秒以内
- 認証状態確認: 1秒以内
- ページ遷移: 2秒以内

**受け入れ基準**
- [ ] 90%のケースで上記基準を満たす

---

### NFR-002: セキュリティ

**要件**

1. **パスワードポリシー**
   - 最小8文字
   - 英数字推奨（Firebase標準）

2. **通信セキュリティ**
   - HTTPS必須（GitHub Pages標準）
   - Firebase通信は暗号化

3. **セッション**
   - トークンの有効期限: 1時間（Firebase標準）
   - 自動更新機能

4. **ドメイン制限**
   - @altx.co.jp のみ許可
   - コード上で強制

**受け入れ基準**
- [ ] パスワードポリシー遵守を強制
- [ ] 不正ドメインでの登録を防止
- [ ] HTTPS通信のみ許可

---

### NFR-003: 可用性

**要件**
- Firebase稼働率: 99.95%（SLA）
- ダウンタイム: 月間最大21分

**受け入れ基準**
- [ ] Firebase障害時の適切なエラーメッセージ表示

---

### NFR-004: 保守性

**要件**
- コードコメント率: 20%以上
- TypeScript strict mode
- ESLint/Prettier適用

**受け入れ基準**
- [ ] すべてのコンポーネントにJSDoc
- [ ] 型定義100%

---

### NFR-005: コスト

**要件**
- Firebase Authentication: 無料枠内（10,000 MAU）
- 追加コスト: ゼロ

**受け入れ基準**
- [ ] 月間アクティブユーザー < 10,000

---

## ユーザーストーリー

### US-001: 新入社員のアカウント作成

**As a** 新入社員
**I want to** 自分でアカウントを作成したい
**So that** すぐにツールを使い始められる

**受け入れ基準**
- 会社のメールアドレスで登録できる
- 24時間以内にパスワードを設定できる
- 設定後すぐにログインできる

---

### US-002: マネージャーによる管理者権限付与

**As a** マネージャー
**I want to** 特定のメンバーに管理者権限を付与したい
**So that** 利益率計算などの管理機能を使ってもらえる

**受け入れ基準**
- CLIスクリプトで簡単に権限付与できる
- 即座に権限が反映される

---

### US-003: 一般ユーザーの閲覧

**As a** 一般社員
**I want to** 自分のプロファイルと同僚のプロファイルを見たい
**So that** チームの相性を理解できる

**受け入れ基準**
- ログイン後、すべてのプロファイルを閲覧できる
- 管理者専用機能には表示されない

---

## 制約事項

### 技術的制約

1. **GitHub Pages**
   - 静的サイトのみ
   - サーバーサイド処理不可

2. **Firebase無料枠**
   - 月間10,000 MAU
   - SMS認証不可（有料）

3. **ゼロコスト原則**
   - 有料サービス利用不可
   - 外部API呼び出し最小限

### ビジネス制約

1. **対象ユーザー**
   - 社員のみ（@altx.co.jp）
   - 最大500名想定

2. **運用体制**
   - 管理者: 開発者1名（suzuki.shunpei@altx.co.jp）
   - ユーザーサポート: セルフサービス

---

## 受け入れ基準

### システム全体

- [ ] すべての機能要件を満たす
- [ ] すべての非機能要件を満たす
- [ ] TDD原則に基づくテストカバレッジ90%以上
- [ ] TypeScriptエラーゼロ
- [ ] ESLintエラーゼロ
- [ ] 開発サーバーで正常動作
- [ ] 本番環境（GitHub Pages）で正常動作

### セキュリティ

- [ ] ドメイン制限が機能する
- [ ] 権限チェックが機能する
- [ ] セッション管理が機能する

### ユーザビリティ

- [ ] 直感的なUI
- [ ] エラーメッセージが分かりやすい
- [ ] レスポンシブデザイン対応

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0 | 2025-12-23 | 初版作成 | SUZUKI Shunpei |
