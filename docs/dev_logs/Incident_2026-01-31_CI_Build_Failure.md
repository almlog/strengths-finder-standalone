# インシデントレポート: CI環境未検証による本番デプロイ失敗

**発生日時**: 2026-01-31
**重大度**: HIGH
**カテゴリ**: 開発プロセス違反
**担当**: Claude (AI開発アシスタント)

---

## 1. インシデント概要

勤怠分析機能（申請カウント24種類対応、シート名からの始業時刻抽出）の実装後、ローカル環境でのビルド成功を確認してmainブランチにpushしたが、GitHub Actions CIビルドが失敗した。

---

## 2. タイムライン

| 時刻 | 事象 |
|------|------|
| - | 機能実装完了、ローカルで `npm run build` 成功 |
| - | ドキュメント整備（README, 仕様書, 開発ログ） |
| - | commit eaba6dc をmainにpush |
| - | GitHub Actions CIビルド失敗 |
| - | ユーザーから「本番環境に反映されていない」と報告 |
| - | 原因調査：ESLint警告がCI環境でエラーに昇格 |
| - | hotfix commit 1d6dae4 でpush |
| - | ユーザーから「なぜローカルで成功してCIで失敗するのか」と質問 |

---

## 3. 根本原因分析

### 直接原因
- 未使用のインポート12件がESLint警告として存在
- CI環境（`CI=true`）ではreact-scriptsがESLint警告をエラーに昇格させる
- ローカル環境では警告のまま → ビルド成功

### 根本原因
1. **CI環境とローカル環境の挙動の違いを認識していなかった**
2. **`npm run build` だけでCI環境を検証したと勘違いした**
3. **CLAUDE.mdに記載されている `npx tsc --noEmit` チェックを省略した**

### 環境差異の詳細

| 環境 | コマンド | ESLint警告の扱い | 結果 |
|------|----------|-----------------|------|
| ローカル | `npm run build` | 警告のまま | ビルド成功 |
| CI環境 | `CI=true npm run build` | エラーに昇格 | ビルド失敗 |

---

## 4. 影響範囲

- **本番環境**: 機能が反映されない
- **ユーザー**: 待機時間の浪費、信頼低下
- **開発プロセス**: 緊急hotfix対応が必要

---

## 5. 再発防止策

### 即時対応（実施済み）

1. CLAUDE.mdに第4の禁止事項として追記
2. 開発フローにCI環境ビルド検証ステップを追加
3. コミット前チェックリストに `CI=true npm run build` を追加
4. 開発品質誓約書に第3回違反として記録

### 恒久対策

| 対策 | 内容 |
|------|------|
| ドキュメント更新 | CLAUDE.md, DEVELOPMENT_QUALITY_PLEDGE.md に明記 |
| チェックリスト追加 | CI環境ビルド検証を必須項目として追加 |
| 過去事例として記録 | 将来の開発時に参照できるよう詳細に記録 |

### 検証コマンド（今後必須）

```bash
# Windows
set CI=true && npm run build

# Mac/Linux
CI=true npm run build
```

---

## 6. 教訓

> **ローカルビルド成功 ≠ CI環境ビルド成功**

- `npm run build` と `CI=true npm run build` は挙動が異なる
- ESLint警告は無視せず、必ず修正すること
- 本番適用前は必ずCI環境を再現して検証すること

---

## 7. 関連ドキュメント

- [CLAUDE.md](../../CLAUDE.md) - 開発ガイド（禁止事項・チェックリスト更新）
- [DEVELOPMENT_QUALITY_PLEDGE.md](../DEVELOPMENT_QUALITY_PLEDGE.md) - 開発品質誓約書（第3回違反追記）
- [Log_2026-01-31_1000_ApplicationCount_EarlyStart.md](./Log_2026-01-31_1000_ApplicationCount_EarlyStart.md) - 機能実装ログ

---

## 8. 承認

| 役割 | 名前 | 日付 |
|------|------|------|
| 報告者 | Claude (AI開発アシスタント) | 2026-01-31 |
| 確認者 | - | - |

---

*このインシデントレポートは、同様の過失を二度と繰り返さないための記録です。*
