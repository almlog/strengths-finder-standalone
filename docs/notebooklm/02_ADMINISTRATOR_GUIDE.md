# 管理者ガイド

## 目次

1. [管理者の役割](#1-管理者の役割)
2. [ユーザー管理](#2-ユーザー管理)
3. [権限管理](#3-権限管理)
4. [Firebase Console操作](#4-firebase-console操作)
5. [データ管理](#5-データ管理)
6. [デプロイ管理](#6-デプロイ管理)
7. [トラブルシューティング](#7-トラブルシューティング)
8. [セキュリティ](#8-セキュリティ)

---

## 1. 管理者の役割

### 1.1 管理者権限でできること

| 機能 | 一般ユーザー | 管理者 |
|------|------------|--------|
| 自身のデータ管理 | ○ | ○ |
| 新規ユーザー登録 | × | ○ |
| ユーザー一覧確認 | × | ○ |
| 管理者権限の付与 | × | ○ |
| Firebase Console操作 | × | ○ |

### 1.2 管理者になる条件

1. Firebase Admin SDKによる権限付与が必要
2. サービスアカウントキーを所持していること
3. npm scriptsを実行できる環境があること

---

## 2. ユーザー管理

### 2.1 新規ユーザーの登録

**方法1: ユーザー自身で登録**

1. ユーザーがログイン画面にアクセス
2. 「新規登録」をクリック
3. 会社メールアドレス（@altx.co.jp）を入力
4. パスワードを設定
5. 登録完了

**注意:** 会社ドメイン以外のメールアドレスは登録できません。

**方法2: Firebase Consoleから登録**

1. Firebase Consoleにログイン
2. Authentication → Users
3. 「ユーザーを追加」をクリック
4. メールアドレスとパスワードを入力
5. 「ユーザーを追加」をクリック

### 2.2 ユーザー一覧の確認

**コマンドライン:**

```bash
npm run admin:list
```

**出力例:**

```
=== ユーザー一覧 ===
1. suzuki.shunpei@altx.co.jp
   - UID: abc123...
   - 作成日: 2026-01-01
   - 最終ログイン: 2026-01-10
   - 管理者: はい

2. tanaka.hanako@altx.co.jp
   - UID: def456...
   - 作成日: 2026-01-05
   - 最終ログイン: 2026-01-09
   - 管理者: いいえ
```

**Firebase Console:**

1. Firebase Consoleにログイン
2. Authentication → Users
3. 登録済みユーザーの一覧を確認

### 2.3 ユーザーの削除

**Firebase Consoleから:**

1. Authentication → Users
2. 削除したいユーザーの行にカーソルを合わせる
3. 右端の「...」メニューをクリック
4. 「アカウントを削除」を選択
5. 確認ダイアログで「削除」をクリック

**注意:** ユーザーを削除してもLocalStorageのデータは残ります。

---

## 3. 権限管理

### 3.1 管理者権限の付与

**前提条件:**
- サービスアカウントキー（firebase-service-account.json）が必要
- プロジェクトルートに配置されていること

**手順:**

```bash
# 管理者権限を付与
npm run admin:set suzuki.shunpei@altx.co.jp
```

**出力例:**

```
管理者権限を付与しました: suzuki.shunpei@altx.co.jp
カスタムクレーム: { admin: true }
```

### 3.2 管理者権限の確認

```bash
npm run admin:list
```

管理者には「管理者: はい」と表示されます。

### 3.3 サービスアカウントキーの取得

1. Firebase Consoleにログイン
2. 「プロジェクトの設定」（歯車アイコン）をクリック
3. 「サービスアカウント」タブを選択
4. 「新しい秘密鍵の生成」をクリック
5. JSONファイルをダウンロード
6. `firebase-service-account.json`としてプロジェクトルートに配置

**セキュリティ警告:**
- このファイルは絶対にGitにコミットしないでください
- `.gitignore`に含まれていることを確認してください
- 安全な場所に保管してください

---

## 4. Firebase Console操作

### 4.1 Consoleへのアクセス

1. https://console.firebase.google.com にアクセス
2. Googleアカウントでログイン
3. プロジェクトを選択

### 4.2 Authentication設定

**ログインプロバイダの確認:**

1. Authentication → Sign-in method
2. 「メール/パスワード」が有効になっていることを確認

**承認済みドメインの確認:**

1. Authentication → Settings → 承認済みドメイン
2. 以下のドメインが登録されていることを確認:
   - localhost
   - almlog.github.io

### 4.3 ユーザーのパスワードリセット

1. Authentication → Users
2. 対象ユーザーの行にカーソルを合わせる
3. 「...」メニュー → 「パスワードをリセット」
4. リセットメールが送信される

---

## 5. データ管理

### 5.1 データの場所

| データ種別 | 保存場所 | 管理方法 |
|-----------|---------|---------|
| ユーザー認証情報 | Firebase Authentication | Firebase Console |
| メンバーデータ | ブラウザLocalStorage | ユーザー個別管理 |
| 設定データ | ブラウザLocalStorage | ユーザー個別管理 |

### 5.2 LocalStorageキー一覧

| キー | 内容 |
|-----|------|
| `strengths_members` | メンバーリスト |
| `strengths_custom_positions` | カスタム役職 |
| `strengths-simulation-state` | シミュレーション状態 |
| `strengths-stage-masters` | ステージマスタ |
| `strengths-member-rates` | 単価情報 |
| `strengths-theme-mode` | テーマ設定 |

### 5.3 データのバックアップ

**ユーザーへの案内:**

1. ログイン後、「設定」→「エクスポート」をクリック
2. JSONファイルがダウンロードされる
3. 安全な場所に保管

**定期バックアップの推奨:**
- 週1回のエクスポートを推奨
- 重要な変更後は即座にエクスポート

### 5.4 データの復元

**ユーザーへの案内:**

1. 「設定」→「インポート」をクリック
2. バックアップJSONファイルを選択
3. 競合解決戦略を選択:
   - Replace: 全置換
   - Add: 新規のみ追加
   - Merge: マージ&更新

---

## 6. デプロイ管理

### 6.1 自動デプロイ

mainブランチへのpush時に自動デプロイが実行されます。

**GitHub Actions設定:**
- ワークフローファイル: `.github/workflows/deploy.yml`
- トリガー: mainブランチへのpush
- デプロイ先: GitHub Pages

### 6.2 デプロイ状況の確認

1. GitHubリポジトリにアクセス
2. 「Actions」タブをクリック
3. 最新のワークフロー実行を確認

**ステータス:**
- ✓ 緑: 成功
- × 赤: 失敗
- ○ 黄: 実行中

### 6.3 デプロイ失敗時の対応

**ログの確認:**

1. 失敗したワークフローをクリック
2. 失敗したステップを展開
3. エラーメッセージを確認

**よくある原因:**

| エラー | 原因 | 対処法 |
|--------|------|--------|
| Module not found | 依存パッケージ未登録 | `npm install <package> --save` |
| TypeScript error | 型エラー | コードを修正 |
| Build failed | ビルドエラー | ローカルでビルドテスト |

### 6.4 手動デプロイ

緊急時や自動デプロイが動作しない場合:

```bash
# ローカルでビルド
npm run build

# buildフォルダの内容をgh-pagesブランチにpush
# または手動でGitHub Pagesにアップロード
```

### 6.5 環境変数の管理

GitHub Secretsに設定:

1. リポジトリの「Settings」→「Secrets and variables」→「Actions」
2. 「New repository secret」をクリック
3. 以下のシークレットを追加:

| シークレット名 | 内容 |
|--------------|------|
| `FIREBASE_API_KEY` | Firebase APIキー |
| `FIREBASE_AUTH_DOMAIN` | Firebase認証ドメイン |
| `FIREBASE_PROJECT_ID` | FirebaseプロジェクトID |
| `FIREBASE_STORAGE_BUCKET` | ストレージバケット |
| `FIREBASE_MESSAGING_SENDER_ID` | メッセージング送信者ID |
| `FIREBASE_APP_ID` | FirebaseアプリID |

---

## 7. トラブルシューティング

### 7.1 ログインできない

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 「メールアドレスが見つかりません」 | 未登録 | 新規登録を案内 |
| 「パスワードが間違っています」 | パスワード誤り | パスワードリセット |
| 「ドメインが許可されていません」 | 非会社ドメイン | 会社メールアドレスを使用 |

### 7.2 データが消えた

| 原因 | 対処法 |
|------|--------|
| ブラウザキャッシュクリア | バックアップからインポート |
| 別ブラウザ使用 | 元ブラウザでエクスポート→インポート |
| シークレットモード | 通常モードで使用 |

### 7.3 画面が正しく表示されない

| 症状 | 対処法 |
|------|--------|
| レイアウト崩れ | ブラウザリロード（F5） |
| グラフ非表示 | ブラウザを最新版に更新 |
| スタイル未適用 | キャッシュクリア後リロード |

### 7.4 勤怠分析エラー

| 症状 | 対処法 |
|------|--------|
| ファイル読み込み失敗 | XLSX形式か確認 |
| 分析結果が空 | 楽楽勤怠の正しいエクスポート形式か確認 |
| 従業員が少ない | シート構成を確認 |

### 7.5 Firebase Emulatorエラー

| 症状 | 対処法 |
|------|--------|
| 起動失敗 | Java JDKがインストールされているか確認 |
| ポート競合 | 他のプロセスを終了、またはポート変更 |
| 認証失敗 | Emulatorモードが有効か確認 |

---

## 8. セキュリティ

### 8.1 認証セキュリティ

**実施済み対策:**
- ドメイン制限（@altx.co.jp のみ）
- パスワード要件（8文字以上）
- Firebase Authenticationによる認証

**推奨事項:**
- 定期的なパスワード変更
- 不審なログインの監視
- 未使用アカウントの削除

### 8.2 データセキュリティ

**実施済み対策:**
- クライアントサイドのみでのデータ保存
- 外部サーバーへのデータ送信なし
- LocalStorageでの暗号化なし（ブラウザ標準）

**推奨事項:**
- 共有PCでの使用を避ける
- 定期的なバックアップ
- 機密性の高いデータは入力しない

### 8.3 サービスアカウントキーの管理

**絶対に守るべきルール:**

1. **Gitにコミットしない**
   - `.gitignore`に含まれていることを確認

2. **安全な場所に保管**
   - クラウドストレージではなく、ローカルの安全な場所

3. **共有しない**
   - 必要最小限の人数のみがアクセス

4. **定期的にローテーション**
   - 半年に1回程度、新しいキーを生成

### 8.4 インシデント対応

**サービスアカウントキー漏洩時:**

1. Firebase Console → プロジェクト設定 → サービスアカウント
2. 漏洩したキーを削除
3. 新しいキーを生成
4. 関係者に報告

**不正アクセス検知時:**

1. 該当ユーザーのパスワードをリセット
2. 必要に応じてアカウント無効化
3. ログを確認して影響範囲を特定
4. 関係者に報告

---

## 付録: 管理コマンド一覧

| コマンド | 説明 |
|---------|------|
| `npm run admin:set <email>` | 管理者権限付与 |
| `npm run admin:list` | ユーザー一覧表示 |
| `npm run emulator` | Firebase Emulator起動 |
| `npm run emulator:ui` | Emulator（UI付き）起動 |
| `npm run build` | 本番ビルド |
| `npm test` | テスト実行 |

---

*最終更新: 2026年1月10日 | バージョン: v3.4*
