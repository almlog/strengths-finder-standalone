# 勤怠分析 ユーザーフィルター機能 仕様書

## 概要

勤怠情報インポート後に、分析対象ユーザーを選択できる機能。
チェックを外したユーザーは分析対象から除外され、すべてのタブに反映される。

## 機能要件

| ID | 要件 | 優先度 | 状態 |
|----|------|--------|------|
| FR-1 | XLSXインポート後、対象ユーザー一覧をチェックボックス付きで表示 | 必須 | 未実装 |
| FR-2 | チェックを外したユーザーは分析対象から除外 | 必須 | 未実装 |
| FR-3 | 除外ユーザーはサマリー・従業員別・部門別・違反一覧すべてに反映 | 必須 | 未実装 |
| FR-4 | 全員選択/全員解除のボタンを提供 | 必須 | 未実装 |
| FR-5 | 部門でユーザーをグルーピングして表示 | 推奨 | 未実装 |
| FR-6 | 選択状態はセッション中のみ保持（LocalStorage不要） | 必須 | 未実装 |

## UI設計

### ユーザー選択パネル

```
┌────────────────────────────────────────────────────────┐
│ 分析対象ユーザーの選択                                   │
│ ┌────────────────────────────────────────────────────┐ │
│ │ [✓ 全員選択] [× 全員解除]  選択中: 25/30名         │ │
│ ├────────────────────────────────────────────────────┤ │
│ │ ▼ 開発部（5名）                                    │ │
│ │   [✓] 山田太郎 (001)                              │ │
│ │   [✓] 鈴木次郎 (002)                              │ │
│ │   [ ] 佐藤三郎 (003) ← 除外                       │ │
│ │ ▼ 営業部（3名）                                    │ │
│ │   [✓] 田中四郎 (004)                              │ │
│ └────────────────────────────────────────────────────┘ │
│ [分析を開始]                                           │
└────────────────────────────────────────────────────────┘
```

### ヘッダーボタン（分析後）

分析結果表示時、ヘッダーエリアに「ユーザー選択」ボタンを配置。
クリックでユーザー選択パネルを再表示し、選択変更後に再分析可能。

## 分析フロー

### 現在のフロー

```
XLSXアップロード → 即時分析（全員） → 結果表示
```

### 変更後のフロー

```
XLSXアップロード → 即時分析（全員選択） → 結果表示
                                        ↓
                                「ユーザー選択」ボタン
                                        ↓
                                ユーザー選択画面 → 再分析
```

**ポイント**: デフォルトは従来通り即時分析。必要な場合のみ「ユーザー選択」ボタンでフィルタリング。

## コンポーネント設計

### UserFilterPanel

```typescript
interface UserFilterPanelProps {
  /** インポートされた勤怠レコード */
  records: AttendanceRecord[];
  /** ユーザーごとの選択状態 (employeeId -> isSelected) */
  userSelections: Map<string, boolean>;
  /** 選択状態変更時のコールバック */
  onSelectionChange: (employeeId: string, isSelected: boolean) => void;
  /** 全員選択ボタンのコールバック */
  onSelectAll: () => void;
  /** 全員解除ボタンのコールバック */
  onDeselectAll: () => void;
  /** 確定ボタンのコールバック */
  onConfirm: () => void;
  /** キャンセルボタンのコールバック */
  onCancel?: () => void;
}
```

### 状態管理（AttendanceAnalysisPage）

```typescript
// 追加する状態
const [userSelections, setUserSelections] = useState<Map<string, boolean>>(new Map());
const [showUserFilter, setShowUserFilter] = useState(false);
const [rawRecords, setRawRecords] = useState<AttendanceRecord[]>([]);
```

## データ構造

### ユーザー情報の抽出

`AttendanceRecord` から以下の情報を抽出してユーザー一覧を構築:

- `employeeId`: 従業員ID
- `employeeName`: 従業員名
- `department`: 部門名

### グルーピング

部門ごとにユーザーをグルーピング。部門が空の場合は「未所属」として表示。

## テスト計画

### 単体テスト（UserFilterPanel.test.tsx）

| テストケース | 説明 |
|-------------|------|
| ユーザー一覧表示 | レコードからユニークユーザーを抽出して表示 |
| 部門別グルーピング | ユーザーが部門ごとにグループ化される |
| チェックボックス操作 | クリックでonSelectionChangeが呼ばれる |
| 全員選択 | 全員選択ボタンでonSelectAllが呼ばれる |
| 全員解除 | 全員解除ボタンでonDeselectAllが呼ばれる |
| 選択数表示 | 「選択中: X/Y名」が正しく表示される |
| 0名選択時 | 確定ボタンが無効化される |
| 確定ボタン | クリックでonConfirmが呼ばれる |

### 統合テスト

| テストケース | 説明 |
|-------------|------|
| フィルター適用 | 除外ユーザーがサマリー・違反一覧に表示されない |
| 再分析 | 選択変更後に再分析が正しく実行される |
| 状態保持 | タブ切り替え後も選択状態が保持される |

## アクセシビリティ

- チェックボックスに適切なラベルを付与
- キーボード操作（Tab/Space）に対応
- スクリーンリーダー対応（aria-label）

## ダークモード対応

既存のダークモードスタイルに準拠:
- 背景: `bg-white dark:bg-gray-800`
- テキスト: `text-gray-900 dark:text-white`
- ボーダー: `border-gray-200 dark:border-gray-700`

---

*作成日: 2026-01-19*
*バージョン: 1.0*
